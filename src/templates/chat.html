{% extends "base.html" %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', path='chat_styles.css') }}">
{% endblock %}

{% block content %}
<div class="main-container">
    <div class="main-history">
        <ul id='messages'></ul>
    </div>
    <h2 class="user-id">Your ID: <span id="ws-id"></span></h2>
    <form class="main-footer" onsubmit="sendMessage(event)">
        <input type="text" class="main-footer-input" id="messageText" placeholder="Write your message">
        <button class="main-footer-btn">Send</button>
    </form>

    <script defer>
        async function getLastMessages() {
            {#TODO switch to second url if deploying#}
            {#const url = 'http://localhost:8000/chat/last_messages'#}
            const url = 'https://global-messenger.onrender.com/chat/last_messages'
            const response = await fetch(url, {
                method: 'GET'
            })
            return response.json()
        }

        getLastMessages()
            .then(messages => {
                appendMessage("Previous messages:")
                messages.forEach(msg => {
                    appendMessage(msg.message)
                })
                appendMessage("\nNew messages:")
            })

        function appendMessage(msg) {
            let messages = document.getElementById('messages')
            let message = document.createElement('li')
            let content = document.createTextNode(msg)
            message.appendChild(content)
            message.classList.add('message')
            messages.appendChild(message)

            let history = document.getElementsByClassName('main-history')[0]
            {#console.log(history.getBoundingClientRect())#}
            {#let historyWindowSize = messages.#}
            {#console.log(messages.getBoundingClientRect())#}

            if (messages.getBoundingClientRect().height >= history.getBoundingClientRect().height * 0.95) {
                messages.removeChild(messages.firstChild)
            }
        }

        let client_id = Date.now()
        document.querySelector("#ws-id").textContent = client_id;
        let ws = new WebSocket(`wss://global-messenger.onrender.com/chat/ws/${client_id}`);
        ws.onmessage = function (event) {
            appendMessage(event.data)
        };

        function sendMessage(event) {
            let input = document.getElementById("messageText")
            ws.send(input.value)
            input.value = ''
            event.preventDefault()
        }
    </script>
</div>
{% endblock %}